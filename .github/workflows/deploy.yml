name: Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch: 

env: 
  COMPOSE_PROJECT_NAME: myapp 

jobs:
  deploy-and-test:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file from secrets 
        shell: cmd
        run: |
          echo # Database configuration > .env
          echo DB_HOST=${{ secrets.DB_HOST }} >> .env
          echo DB_PORT=${{ secrets.DB_PORT }} >> .env
          echo DB_NAME=${{ secrets.DB_NAME }} >> .env
          echo DB_USER=${{ secrets.DB_USER }} >> .env
          echo DB_PASSWORD=${{ secrets.DB_PASSWORD }} >> .env
          echo # Application configuration >> .env
          echo APP_PORT=${{ secrets.APP_PORT }} >> .env
          echo APP_SECRET=${{ secrets.APP_SECRET }} >> .env
          echo API_KEY=${{ secrets.API_KEY }} >> .env
          echo # Docker configuration >> .env
          echo COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }} >> .env
          echo "‚úÖ .env file created successfully" 
          echo "Contents (masked):" 
          type .env | findstr /n ".*"
          copy .env environment.txt

      - name: Deploy with Docker Compose
        shell: cmd
        run: | 
          cd ../../../../
          cd mysite

          echo "üöÄ Starting application stack..." 
          timeout /t 30 /nobreak > nul
          docker-compose up -d
          echo "‚è≥ Waiting for services to start..." 
          timeout /t 30 /nobreak > nul
          echo "üìä Checking container status..." 
          docker-compose ps

      - name: Verify containers are running
        shell: cmd
        run: |
          docker-compose ps | find "Up" > nul
          if %errorlevel% == 0 (
            echo "‚úÖ All containers are running"
          ) else (
            echo "‚ùå Some containers failed to start"
            docker-compose logs
            exit /b 1
          )

      - name: Run application tests
        shell: cmd
        run: | 
          echo "üß™ Running application tests..." 
          :: –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ë–î 
          echo "1. Testing application and database connectivity..." 

          curl -f http://localhost:${{ secrets.APP_PORT }}/health/
          if %errorlevel% equ 0 (
            echo "‚úÖ Web application is healthy"
          ) else (
            echo "‚ùå Web application health check failed"
            exit /b 1
          )

          :: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 
          curl -s http://localhost:${{ secrets.APP_PORT }}/api/data > nul
          if %errorlevel% equ 0 (
              echo ‚úÖ Application database connection working
          ) else (
              echo ‚ùå Application database connection failed
              exit /b 1
          )

          :: –¢–µ—Å—Ç 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ë–î –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ 
          echo "2. Testing data consistency..." 
          
          :: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î 
          docker-compose exec -T db psql -U ${{ secrets.DB_USER }} -d ${{secrets.DB_NAME}} -t -c "SELECT COUNT(*) FROM auth_user;" > temp.txt
          set /p DB_COUNT=<temp.txt
          set DB_COUNT=%DB_COUNT: =%
          del temp.txt

          :: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–µ–±-API 
          curl -s http://localhost:${{ secrets.APP_PORT }}/api/data/ | jq -r ".count_of_user" > temp.txt
          set /p WEB_COUNT=<temp.txt
          del temp.txt
          echo Count: %WEB_COUNT%

          echo "Database count: %DB_COUNT%" 
          echo "Web API count: %WEB_COUNT%" 

          if %DB_COUNT% equ %WEB_COUNT% (
            echo "‚úÖ Data consistency test passed"
          ) else (
            echo "‚ùå Data consistency test failed"
            exit /b 1 
          )

          ::–°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
          echo %DB_COUNT% > db_count.txt
          echo %WEB_COUNT% > web_count.txt

      - name: Create test report
        shell: cmd
        run: |

          ::–°—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—ã–Ω–Ω–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ –∏ —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã
          set /p DB_COUNT=<db_count.txt
          set /p WEB_COUNT=<web_count.txt
          del db_count.txt
          del web_count.txt

          echo "üìã Creating test report..."
          set CURRENT_DATE=%date% %time%
          (
          echo # Deployment Test Report
          echo - Date: %CURRENT_DATE%
          echo - Application: Healthy ‚úÖ
          echo - Database: Connected ‚úÖ
          echo - Data Consistency: Passed ‚úÖ
          echo - Containers: Running ‚úÖ
          echo.
          echo ## Environment Variables
          echo - DB_HOST: ${{ secrets.DB_HOST }}
          echo - DB_NAME:  ${{ secrets.DB_NAME }}
          echo - APP_PORT:  ${{ secrets.APP_PORT }}
          echo.
          echo ## Test Results
          echo - Database records: %DB_COUNT%
          echo - Web API records: %WEB_COUNT%
          ) > test-report.md
      
      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            environment.txt
            test-report.md
            deployment-logs.txt 
          retention-days: 30


    