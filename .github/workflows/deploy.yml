name: Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch: 

env: 
  COMPOSE_PROJECT_NAME: myapp 

jobs:
  deploy-and-test:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug secrets
        run: |
          echo "DB_HOST exists: ${{ secrets.DB_HOST != '' }}"
          echo "DB_NAME exists: ${{ secrets.DB_NAME != '' }}"
          # Ð¸ Ñ‚Ð°Ðº Ð´Ð»Ñ Ð²ÑÐµÑ… ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²

      - name: Create .env file from secrets 
        shell: cmd
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          APP_PORT: ${{ secrets.APP_PORT }}
          APP_SECRET: ${{ secrets.APP_SECRET }}
          API_KEY: ${{ secrets.API_KEY }}
          COMPOSE_PROJECT_NAME: ${{ env.COMPOSE_PROJECT_NAME }}
        run: |
          echo # Database configuration > .env
          echo DB_HOST=%DB_HOST% >> .env
          echo DB_PORT=%DB_PORT% >> .env
          echo DB_NAME=%DB_NAME% >> .env
          echo DB_USER=%DB_USER% >> .env
          echo DB_PASSWORD=%DB_PASSWORD% >> .env
          echo # Application configuration >> .env
          echo APP_PORT=%APP_PORT% >> .env
          echo APP_SECRET=%APP_SECRET% >> .env
          echo API_KEY=%API_KEY% >> .env
          echo # Docker configuration >> .env
          echo COMPOSE_PROJECT_NAME=%COMPOSE_PROJECT_NAME% >> .env
          echo "âœ… .env file created successfully" 
          echo "Contents (masked):" 
          type .env | findstr /n ".*"

      - name: Deploy with Docker Compose
        shell: cmd
        run: | 
          cd ../../../../
          cd mysite

          echo "ðŸš€ Starting application stack..." 
          timeout /t 30 /nobreak > nul
          docker-compose up -d
          echo "â³ Waiting for services to start..." 
          timeout /t 30 /nobreak > nul
          echo "ðŸ“Š Checking container status..." 
          docker-compose ps

      - name: Verify containers are running
        shell: cmd
        run: |
          docker-compose ps | find "Up" > nul
          if %errorlevel% == 0 (
            echo "âœ… All containers are running"
          ) else (
            echo "âŒ Some containers failed to start"
            docker-compose logs
            exit /b 1
          )

      - name: Run application tests
        shell: cmd
        run: | 
          echo "ðŸ§ª Running application tests..." 
          :: Ð¢ÐµÑÑ‚ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¸ Ð‘Ð” 
          echo "1. Testing application and database connectivity..." 

          curl -f http://localhost:8000/health/
          if %errorlevel% equ 0 (
            echo "âœ… Web application is healthy"
          ) else (
            echo "âŒ Web application health check failed"
            exit /b 1
          )

          :: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ 
          curl -s http://localhost:8000/api/data > nul
          if %errorlevel% equ 0 (
              echo âœ… Application database connection working
          ) else (
              echo âŒ Application database connection failed
              exit /b 1
          )

          :: Ð¢ÐµÑÑ‚ 2: Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð‘Ð” Ð¸ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ° 
          echo "2. Testing data consistency..." 
          
          :: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð¸Ð· Ð‘Ð” 
          docker-compose exec -T db psql -U user -d mydatabase -t -c "SELECT COUNT(*) FROM auth_user;" > temp.txt
          set /p DB_COUNT=<temp.txt
          set DB_COUNT=%DB_COUNT: =%
          del temp.txt

          :: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÐ±-API 
          curl -s http://localhost:8000/api/data/ | jq -r ".count_of_user" > temp.txt
          set /p WEB_COUNT=<temp.txt
          del temp.txt
          echo Count: %WEB_COUNT%

          echo "Database count: %DB_COUNT%" 
          echo "Web API count: %WEB_COUNT%" 

          if %DB_COUNT% equ %WEB_COUNT% (
            echo "âœ… Data consistency test passed"
          ) else (
            echo "âŒ Data consistency test failed"
            exit /b 1 
          )