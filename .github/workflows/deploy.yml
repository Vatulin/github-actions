name: Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch: 

env: 
  COMPOSE_PROJECT_NAME: myapp 

jobs:
  deploy-and-test:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file from secrets 
        shell: cmd
        run: |
          echo # Database configuration > .env
          echo DB_HOST=${{ secrets.DB_HOST }} >> .env
          echo DB_PORT=${{ secrets.DB_PORT }} >> .env
          echo DB_NAME=${{ secrets.DB_NAME }} >> .env
          echo DB_USER=${{ secrets.DB_USER }} >> .env
          echo DB_PASSWORD=${{ secrets.DB_PASSWORD }} >> .env
          echo # Application configuration >> .env
          echo APP_PORT=${{ secrets.APP_PORT }} >> .env
          echo APP_SECRET=${{ secrets.APP_SECRET }} >> .env
          echo API_KEY=${{ secrets.API_KEY }} >> .env
          echo # Docker configuration >> .env
          echo COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }} >> .env
          echo "‚úÖ .env file created successfully" 
          echo "Contents (masked):" 
          type .env | findstr /n ".*"

      - name: Deploy with Docker Compose
        shell: cmd
        run: | 
          cd ../../../../
          cd mysite

          echo "üöÄ Starting application stack..." 
          docker-compose up -d
          echo "‚è≥ Waiting for services to start..." 
          timeout /t 30 /nobreak > nul
          echo "üìä Checking container status..." 
          docker-compose ps

      - name: Verify containers are running
        shell: cmd
        run: |
          docker-compose ps | find "Up" > nul
          if %errorlevel% == 0 (
            echo "‚úÖ All containers are running"
          ) else (
            echo "‚ùå Some containers failed to start"
            docker-compose logs
            exit /b 1
          )

      - name: Run application tests
        shell: cmd
        run: | 
          echo "üß™ Running application tests..." 
          :: –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ë–î 
          echo "1. Testing application and database connectivity..." 

          curl -f http://localhost:8000/health/
          if %errorlevel% == 0 (
            echo "‚úÖ Web application is healthy"
          ) else (
            echo "‚ùå Web application health check failed"
            exit /b 1
          )

          :: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 
          for /f "delims=" %i in ('curl -s http://localhost:8000/api/data/') do set API_RESPONSE=%i
          if %errorlevel% equ 0 (
          echo ‚úÖ Application database connection working
          ) else (
              echo ‚ùå Application database connection failed
              exit /b 1 
          )

          # –¢–µ—Å—Ç 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ë–î –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ 
          echo "2. Testing data consistency..." 